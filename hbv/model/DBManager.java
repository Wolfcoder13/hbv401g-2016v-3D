package hbv.model;

import java.io.File;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;

/* Þessi class er ekki mockObject þar sem við vorum byrjaðir
   á honum fyrir. Okkur fannst því óþarfi að að vera gera annan
   klasa þar sem þessi var alveg tilbúinn til notkunar fyrir þetta 
   verkefni.

   Eina fallið í klasanum sem skiptir máli fyrir verkefnið
   er í raun getTours().
*/
public class DBManager {

	private static Connection conn = null;
	private static PreparedStatement pst = null;
	private static ResultSet res = null;
	
	// Bý til tengingu við sqlite gagnagrunninn
	private static void setUp(){
		try{
			Class.forName("org.sqlite.JDBC");
			File database = new File("src\\HBV.db");
			String dbPath = database.getAbsolutePath();
			conn = DriverManager.getConnection("JDBC:sqlite:"+dbPath);
		}catch(ClassNotFoundException e){
			e.printStackTrace();
		}catch(SQLException e){
			e.printStackTrace();
		}
	}
	
	// Loka öllum tengingum
	private static void closeAll(){
		try {
			//pst.close();
			//res.close();
			conn.close();
			
		} catch (SQLException e) {
			e.printStackTrace();
		}
	}
	
	// Þetta er eina fallið sem skiptir máli fyrir þessi skil.
	public static String[][] getTours(String table,ArrayList<String> searchParams) throws noDataException{
		setUp();
		
		//Statement stmtTours = null;
		Statement stmtRows = null;
		// Fylli tours á eftir með gögnunum í resultsettinu sem fæst úr SQL-fyrirspurninni.
		String[][] tours = null;
		
		
		try {
			// Fæ fjölda raða sem munu koma út úr SQL-fyrirspurninni.
			String prepared = "SELECT COUNT(*) FROM "+table;
			if(searchParams.size()>0) prepared += " WHERE";
			for(String searchParam: searchParams){
				prepared += " ? AND";
			}
			
			prepared = prepared.substring(0,prepared.length()-4);
			prepared += ";";
			System.out.println(prepared);
			pst = conn.prepareStatement(prepared);
			pst.setString(1, "price=17000");
			/*
			for(int i=0;i<searchParams.size();i++){
				pst.setString(i+1, searchParams.get(i));
			}*/
			res = pst.executeQuery();
			
			
			//stmtRows = conn.createStatement();
			
			
			
			
			//pst.setString(1,rowCounter);
			//pst.setString(2, searchParams);
			//pst.setString(2, from);
			//pst.setString(3, whereString);
			//res = pst.executeQuery();
			int rows = Integer.valueOf(res.getString(1));
			System.out.println(rows);
			//if(rows==0) throw new noDataException();

			// Fæ gögnin sjálf.			
			pst.setString(1,"*");
			res = pst.executeQuery();
			//stmtTours = conn.createStatement();
			//res = stmtTours.executeQuery("SELECT * FROM Tours WHERE "+whereString+";");
	
			// Fæ fjölda dálka í leitarniðurstöðunum.
 			ResultSetMetaData rsmd = res.getMetaData();
			int cols = rsmd.getColumnCount();	
			
			// Þurfti að vita víddirnar á resultSet til að geta upphafsstillt tours hér.
			tours = new String[rows][cols];
			// Færi svo gögnin í óháða 2D fylkið tours, sem verður skilagildi fallsins.
			int i = 0;
			while(res.next()){
				for(int j = 0; j<cols;j++){
					tours[i][j] = res.getString(j+1);
				}
				i++;
			}
		} catch (SQLException e) {
			e.printStackTrace();
		} finally{
			closeAll();
		}
		return tours;
	}
	
	// TODO klára
	public static String[] getTourReviews(){
		String[] tourReviews = null;
		return tourReviews;
	}
	
	// TODO klára
	public static String[][] getGuides(){
		String[][] guides = null;
		return guides;
	}
	
	// TODO klára
	public static String[] getGuideReviews(){
		String[] guideReviews = null;
		return guideReviews;
	}
	
	public static void updateSeats(String tourName,int newSeats){
		setUp();
		
		try {
			pst = conn.prepareStatement("UPDATE Tours SET SeatsAvailable=? "
					+ "WHERE name=?");
			pst.setString(1, String.valueOf(newSeats));
			pst.setString(2, tourName);
			pst.execute();
		} catch (SQLException e) {
			e.printStackTrace();
		} finally{ 
			closeAll();	
		}
	}
	
	public static void updateRating(String tourName, float newRating, int numberOfRatings){
		setUp();
		try {
			pst = conn.prepareStatement("UPDATE Tours SET Rating=? "
					+ "WHERE name=?");
			pst.setString(1, String.valueOf(newRating));
			pst.setString(2, tourName);
			pst.execute();
			
			pst = conn.prepareStatement("UPDATE Tours SET NumberOfRatings=? "
					+ "WHERE name=?");
			pst.setString(1, String.valueOf(numberOfRatings));
			pst.setString(2, tourName);
			pst.execute();
		} catch (SQLException e) {
			e.printStackTrace();
		} finally{
			closeAll();	
		}
	}
}
